@page "/"
@page "/topcoins"
@using DarraghConway_CA1.Client.Services.Abstractions
@using DarraghConway_CA1.Client.Models
@inject IMarketDataService MarketData
@inject NavigationManager Nav

<h3 class="mb-3">Top 20 Cryptocurrencies</h3>

@if (cryptos is null)
{
    <div class="d-flex align-items-center text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
        Loadingâ€¦
    </div>
}
else
{
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive" style="overflow-y: visible;">
                <table class="table table-sm table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width:60px;">Rank</th>
                            <th style="width:48px;"></th>
                            <th>Name</th>
                            <th>Symbol</th>
                            <th class="text-end">Price (USD)</th>
                            <th class="text-end">Market Cap (USD)</th>
                            <th class="text-end">24h</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in cryptos)
                        {
                            var usd = c.Quote?["USD"];
                            var change = usd?.PercentChange24h ?? 0m;
                            var changeClass = change >= 0
                                ? "bg-success bg-opacity-10 text-success border border-success"
                                : "bg-danger bg-opacity-10 text-danger border border-danger";

                            <tr role="button"
                                style="cursor:pointer"
                                onclick="location.href='@($"/coin/{c.Symbol}")'">
                                <td class="text-center fw-semibold align-middle">@c.CmcRank</td>
                                <td class="align-middle">
                                    <img src="@($"https://s2.coinmarketcap.com/static/img/coins/64x64/{c.Id}.png")"
                                         alt="@c.Name logo" width="28" height="28"
                                         class="rounded-circle shadow-sm" />
                                </td>

                                <!-- Inline tooltip inside the Name cell -->
                                <td class="fw-semibold align-middle position-relative">
                                    <span class="tip-wrap">
                                        @c.Name
                                        <span class="tip-bubble">ðŸ“° Click to view @c.Symbol news</span>
                                    </span>
                                </td>

                                <td class="text-muted align-middle">@c.Symbol</td>
                                <td class="text-end text-nowrap align-middle">
                                    @(usd?.Price.ToString("C2", System.Globalization.CultureInfo.GetCultureInfo("en-US")))
                                </td>
                                <td class="text-end text-nowrap align-middle">
                                    @(usd?.MarketCap.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("en-US")))
                                </td>
                                <td class="text-end align-middle">
                                    <span class="badge @changeClass">@change.ToString("0.00")%</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    private List<CryptoListing>? cryptos;

    protected override async Task OnInitializedAsync()
        => cryptos = await MarketData.GetLatestAsync(20);

    private void NavigateToCoin(string symbol)
        => Nav.NavigateTo($"/coin/{symbol}");
}
